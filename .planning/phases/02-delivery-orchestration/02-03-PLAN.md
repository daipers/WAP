---
phase: 02-delivery-orchestration
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - dev_package/src/delivery_service/integrity_config.py
  - dev_package/src/delivery_service/integrity_events.py
  - dev_package/src/delivery_service/lockdown.py
autonomous: true

must_haves:
  truths:
    - "User can configure lockdown settings per assessment"
    - "System logs integrity events with precise timestamps"
    - "Fullscreen enter/exit events are captured"
    - "Tab visibility changes are logged"
    - "Network disconnect/reconnect events are recorded"
  artifacts:
    - path: "dev_package/src/delivery_service/integrity_config.py"
      provides: "Lockdown configuration dataclass and defaults"
      exports: ["LockdownConfig", "LockdownLevel", "get_default_config"]
    - path: "dev_package/src/delivery_service/integrity_events.py"
      provides: "Integrity event logging using audit ledger"
      exports: ["IntegrityEventLogger", "IntegrityEventType", "log_event"]
    - path: "dev_package/src/delivery_service/lockdown.py"
      provides: "Lockdown enforcement helpers"
      exports: ["LockdownEnforcer", "check_violation"]
  key_links:
    - from: "integrity_events.py"
      to: "audit_ledger_service.ledger"
      via: "AuditLedger.record_event"
      pattern: "audit_ledger.*record"
---

<objective>
Build integrity controls for configurable lockdown settings and precise event logging using the existing audit ledger.
</objective>

<tasks>

<task type="auto">
  <name>Create lockdown configuration</name>
  <files>dev_package/src/delivery_service/integrity_config.py</files>
  <action>
Create:
- LockdownLevel enum: NONE, STANDARD, STRICT
- LockdownConfig dataclass: require_fullscreen, block_copy_paste, block_keyboard_shortcuts, allow_text_selection, max_tab_switches, log_all_events
- get_default_config(level): returns preset configs for each level
- AssessmentDefinition.lockdown field (optional LockdownConfig)

Default STDARD: require_fullscreen=true, block_copy_paste=true, max_tab_switches=3
  </action>
  <verify>LockdownConfig can be created with all fields</verify>
  <done>LockdownConfig with presets exists and applies to assessment</done>
</task>

<task type="auto">
  <name>Implement integrity event logging</name>
  <files>dev_package/src/delivery_service/integrity_events.py</files>
  <action>
Create IntegrityEventType enum with: FULLSCREEN_ENTER, FULLSCREEN_EXIT, TAB_VISIBLE, TAB_HIDDEN, COPY_ATTEMPT, PASTE_ATTEMPT, KEYBOARD_SHORTCUT, NETWORK_DISCONNECT, NETWORK_RECONNECT

Create IntegrityEventLogger class that:
- Wraps AuditLedger from audit_ledger_service
- log_event(session_id, event_type, metadata): records to ledger with precise timestamp
- get_session_events(session_id): retrieves integrity events for session

Use time.time() for precise timestamps (float, milliseconds). Leverage existing AuditLedger.
  </action>
  <verify>Integrity events recorded to audit ledger with timestamps</verify>
  <done>IntegrityEventLogger logs all event types with timestamps</done>
</task>

<task type="auto">
  <name>Create lockdown enforcement helpers</name>
  <files>dev_package/src/delivery_service/lockdown.py</files>
  <action>
Create LockdownEnforcer class that:
- Takes LockdownConfig and AssessmentSession
- check_violation(event_type, count): returns violation bool based on config
- For STANDARD: >3 tab switches = violation
- For STRICT: any fullscreen exit = violation
- get_enforcement_rules(): returns JS snippet for frontend to enforce

Also create helper to integrate with delivery_api: apply_lockdown_rules(config, event_type, counts).
  </action>
  <verify>LockdownEnforcer correctly identifies violations</verify>
  <done>check_violation returns correct bool based on config thresholds</done>
</task>

</tasks>

<verification>
- LockdownConfig applies to assessment definition
- Integrity events logged with timestamps matching audit ledger
- Tab switch violations detected correctly
- Fullscreen exit violations detected in STRICT mode
</verification>

<success_criteria>
System supports configurable lockdown/integrity controls; integrity events logged with precise timestamps.
</success_criteria>

<output>
After completion, create `.planning/phases/02-delivery-orchestration/02-03-SUMMARY.md`
</output>
